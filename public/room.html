<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Details - FunXLink Studio Phira Server</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <script src="i18n.js"></script>
</head>
<body>
    <script>(function(){
        const t=localStorage.getItem('theme');if(t==='dark')document.body.classList.add('dark-mode');
        I18n.init();
    })()</script>
    <div id="announcement-popup"></div>
    <div class="container">
        <!-- Secret Admin Modal -->
        <div id="admin-secret-modal" class="admin-modal-overlay">
            <div class="admin-modal">
                <button class="admin-modal-close" onclick="document.getElementById('admin-secret-modal').style.display='none'">&times;</button>
                <div class="admin-modal-header">
                    <div class="admin-modal-title">Admin Management Panel</div>
                </div>
                <div class="admin-modal-body">
                    <div class="admin-modal-grid" id="admin-modal-buttons">
                        <!-- Buttons 1-20 will be injected here -->
                    </div>
                </div>
            </div>
        </div>

        <header>
            <h1 id="room-name" data-i18n="common.loading">Loading Room...</h1>
            <div id="total-players"></div>
            <div class="connection-status" id="connection-status" data-i18n="common.loading">Connecting...</div>
        </header>
        <main>
            <a href="/" class="back-link" data-i18n="room.back_home">&larr; Back to Room List</a>
            <div id="room-details" class="details-grid">
                <!-- Room details will be injected here -->
            </div>
        </main>
        <footer>
            <p data-i18n="common.server_ip">Game Server IP:</p>
            <div class="server-ip-container" id="copy-ip" data-i18n-title="common.click_to_copy">
                <code id="server-ip">...</code>
                <span class="copy-icon">&#128203;</span>
            </div>
                <script>
                    // Update server IP and title from config if available
                    if (window.SERVER_CONFIG) {
                        if (window.SERVER_CONFIG.displayIp) {
                            document.getElementById('server-ip').textContent = window.SERVER_CONFIG.displayIp;
                        }
                        if (window.SERVER_CONFIG.serverName) {
                            document.title = `Room Details - ${window.SERVER_CONFIG.serverName}`;
                        }
                    }
                </script>            <div class="footer-controls">
                <button id="theme-toggle" class="theme-toggle-btn">
                    <span id="theme-icon" class="theme-icon">üåô</span>
                    <span id="theme-text" data-i18n="common.dark_mode">Dark Mode</span>
                </button>
                <button id="lang-toggle" class="lang-toggle-btn" onclick="I18n.toggleLanguage()">
                    <span>üåê</span>
                    <span id="lang-toggle-text">English</span>
                </button>
            </div>
        </footer>
    </div>
    <script src="room.js"></script>
    <script>
        // Theme Toggle Logic
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');
        const body = document.body;

        function updateThemeUI(isDark) {
            if (!I18n.isReady) return;
            themeIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            themeText.textContent = isDark ? I18n.t('common.light_mode') : I18n.t('common.dark_mode');
        }

        document.addEventListener('i18nReady', () => {
            updateThemeUI(body.classList.contains('dark-mode'));
        });

        themeToggle.addEventListener('click', () => {
            const isDark = body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeUI(isDark);
        });

        document.getElementById('copy-ip').addEventListener('click', () => {
            const ip = document.getElementById('server-ip').textContent;
            navigator.clipboard.writeText(ip).then(() => {
                alert(I18n.t('common.copy_success'));
            }).catch(err => {
                console.error('Copy failed: ', err);
            });
        });

        // Easter Egg Logic
        (function() {
            let clickCount = 0;
            let lastClickTime = 0;
            const title = document.getElementById('room-name');
            if (title) {
                title.style.userSelect = 'none';
                title.style.cursor = 'pointer';
                title.addEventListener('click', async () => {
                    const currentTime = Date.now();
                    if (currentTime - lastClickTime < 500) {
                        clickCount++;
                    } else {
                        clickCount = 1;
                    }
                    lastClickTime = currentTime;
                    if (clickCount === 5) {
                        clickCount = 0;
                        alert(I18n.t('room.easter_egg_alert'));

                        // Check if admin is logged in
                        try {
                            const res = await fetch('/check-auth');
                            const auth = await res.json();
                            if (auth.isAdmin) {
                                showSecretAdminModal();
                            }
                        } catch (e) {}
                    }
                });
            }

            function showSecretAdminModal() {
                const modal = document.getElementById('admin-secret-modal');
                const grid = document.getElementById('admin-modal-buttons');
                if (!modal || !grid) return;

                grid.innerHTML = '';
                for (let i = 1; i <= 20; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'admin-btn';
                    
                    if (i === 1) {
                        btn.textContent = I18n.currentLang === 'zh' ? 'ÂÖ®ÊúçÊí≠Êä•' : 'Global Broadcast';
                        btn.classList.add('action-primary');
                        btn.onclick = async () => {
                            const target = prompt(I18n.currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•ËåÉÂõ¥ (Áõ¥Êé•ÂõûËΩ¶ÂÖ®ÈÉ®ÔºåÊàñËæìÂÖ• #ID1,ID2)Ôºö' : 'Enter target (Enter for all, or #ID1,ID2):', 'all');
                            if (target === null) return;
                            const content = prompt(I18n.currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•Êí≠Êä•ÂÜÖÂÆπÔºö' : 'Enter broadcast content:');
                            if (!content || !content.trim()) return;
                            try {
                                const res = await fetch('/api/admin/broadcast', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ content, target })
                                });
                                const result = await res.json();
                                if (result.success) alert(I18n.t('room.admin.success'));
                            } catch (e) { alert('Failed'); }
                        };
                    } else if (i === 2) {
                        btn.textContent = I18n.currentLang === 'zh' ? 'ÂÖ≥Èó≠ÊàøÈó¥' : 'Close Room';
                        btn.classList.add('action-danger');
                        btn.onclick = async () => {
                            const target = prompt(I18n.currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•ËåÉÂõ¥ (ËæìÂÖ• "all" Êàñ "#ID1,ID2")Ôºö' : 'Enter target ("all" or "#ID1,ID2"):');
                            if (!target || !target.trim()) return;
                            if (!confirm(I18n.currentLang === 'zh' ? `Á°ÆËÆ§ÊâßË°åÊ≠§Êìç‰ΩúÔºüËåÉÂõ¥: ${target}` : `Confirm action for: ${target}`)) return;
                            try {
                                await fetch('/api/admin/bulk-action', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ action: 'close_all', target })
                                });
                                location.href = '/';
                            } catch (e) { alert('Failed'); }
                        };
                    } else if (i === 3 || i === 4) {
                        const isLock = i === 3;
                        btn.textContent = isLock 
                            ? (I18n.currentLang === 'zh' ? 'ÈîÅÂÆöÊâÄÊúâÊàøÈó¥' : 'Lock All Rooms')
                            : (I18n.currentLang === 'zh' ? 'Ëß£ÈîÅÊâÄÊúâÊàøÈó¥' : 'Unlock All Rooms');
                        btn.classList.add(isLock ? 'action-warning' : 'action-success');
                        btn.onclick = async () => {
                            const target = prompt(I18n.currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•ËåÉÂõ¥ (ËæìÂÖ• "all" Êàñ "#ID1,ID2")Ôºö' : 'Enter target ("all" or "#ID1,ID2"):', 'all');
                            if (!target || !target.trim()) return;
                            if (!confirm(I18n.currentLang === 'zh' ? `Á°ÆËÆ§ÊâßË°åÊ≠§Êìç‰ΩúÔºüËåÉÂõ¥: ${target}` : `Confirm action for: ${target}`)) return;
                            try {
                                await fetch('/api/admin/bulk-action', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ action: isLock ? 'lock_all' : 'unlock_all', target })
                                });
                                alert(I18n.t('room.admin.success'));
                            } catch (e) { alert('Failed'); }
                        };
                    } else if (i === 5) {
                        btn.textContent = I18n.currentLang === 'zh' ? 'ÊâπÈáè‰øÆÊîπ‰∫∫Êï∞' : 'Bulk Set Size';
                        btn.classList.add('action-warning');
                        btn.onclick = async () => {
                            const target = prompt(I18n.currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•ËåÉÂõ¥ (ËæìÂÖ• "all" Êàñ "#ID1,ID2")Ôºö' : 'Enter target ("all" or "#ID1,ID2"):', 'all');
                            if (!target || !target.trim()) return;
                            const value = prompt(I18n.currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•Áªü‰∏ÄÁöÑ‰∫∫Êï∞‰∏äÈôêÔºö' : 'Enter max players:');
                            if (!value || isNaN(parseInt(value))) return;
                            try {
                                await fetch('/api/admin/bulk-action', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ action: 'set_max_players', value: parseInt(value), target })
                                });
                                alert(I18n.t('room.admin.success'));
                            } catch (e) { alert('Failed'); }
                        };
                    } else if (i === 7 || i === 8) {
                        const isDisable = i === 7;
                        btn.textContent = isDisable 
                            ? (I18n.currentLang === 'zh' ? 'Á¶ÅÊ≠¢ÂàõÂª∫ÊàøÈó¥' : 'Disable Room Creation')
                            : (I18n.currentLang === 'zh' ? 'ÂÖÅËÆ∏ÂàõÂª∫ÊàøÈó¥' : 'Enable Room Creation');
                        btn.classList.add(isDisable ? 'action-warning' : 'action-success');
                        btn.onclick = async () => {
                            const msg = isDisable 
                                ? (I18n.currentLang === 'zh' ? 'Á°ÆÂÆöË¶ÅÁ¶ÅÊ≠¢ÂàõÂª∫Êñ∞ÊàøÈó¥ÂêóÔºü' : 'Disable NEW rooms?')
                                : (I18n.currentLang === 'zh' ? 'Á°ÆÂÆöË¶ÅÂÖÅËÆ∏ÂàõÂª∫Êñ∞ÊàøÈó¥ÂêóÔºü' : 'Enable NEW rooms?');
                            if (!confirm(msg)) return;
                            try {
                                await fetch('/api/admin/bulk-action', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ action: isDisable ? 'disable_room_creation' : 'enable_room_creation' })
                                });
                                alert(I18n.t('room.admin.success'));
                            } catch (e) { alert('Failed'); }
                        };
                    } else {
                        btn.textContent = (I18n.currentLang === 'zh' ? 'ÂäüËÉΩ ' : 'Function ') + i;
                        btn.onclick = () => alert(btn.textContent + ' clicked!');
                    }
                    grid.appendChild(btn);
                }

                modal.style.display = 'flex';
            }
        })();
    </script>
</body>
</html>
