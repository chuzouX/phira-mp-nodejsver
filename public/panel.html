<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="admin.panel_title">Admin Management Panel</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <style>
        .ban-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .ban-table th, .ban-table td { border: 1px solid #ddd; padding: 12px 8px; text-align: left; }
        .dark-mode .ban-table th, .dark-mode .ban-table td { border-color: #444; }
        .ban-table th { background-color: var(--muted-bg); color: var(--header-color); }
        .ban-table-container { max-height: 400px; overflow-y: auto; border-radius: 8px; border: 1px solid var(--border-color); }
        
        .admin-panel-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-top: 20px;
        }

        .panel-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .panel-card h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--header-color);
            border-bottom: 2px solid var(--primary-color);
            display: inline-block;
            padding-bottom: 5px;
        }

        input[type="text"], input[type="number"], select {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            font-size: 0.9rem;
            outline: none;
            transition: var(--transition);
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .action-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .ban-add-section {
            background-color: var(--muted-bg);
            padding: 20px;
            border-radius: var(--radius-md);
            margin-top: 20px;
        }

        /* Room Selection Styles */
        .room-selector-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
        }
        .room-chip-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 120px;
            overflow-y: auto;
            padding: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
        }
        .room-chip {
            padding: 4px 12px;
            border-radius: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .room-chip:hover { border-color: var(--primary-color); }
        .room-chip.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .select-all-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }
    </style>
    <script src="i18n.js"></script>
</head>
<body>
    <script>(function(){
        const t=localStorage.getItem('theme');if(t==='dark')document.body.classList.add('dark-mode');
        I18n.init();
    })()</script>

    <div class="container">
        <header>
            <h1 data-i18n="admin.panel_title">Admin Management Panel</h1>
            <div class="footer-controls" style="margin: 0;">
                <a href="/" class="back-link" style="margin: 0;" data-i18n="common.back_home">Back to Home</a>
                <button id="theme-toggle" class="theme-toggle-btn">
                    <span id="theme-icon" class="theme-icon">üåô</span>
                </button>
            </div>
        </header>

        <div class="admin-panel-container">
            <!-- Server Control -->
            <section class="panel-card">
                <h2 data-i18n="admin.server_control">Server Control</h2>
                
                <div class="ban-add-section">
                    <strong data-i18n="room.admin.message">Global Broadcast</strong>
                    <div class="room-selector-container" style="margin-top: 15px;">
                        <div class="select-all-row">
                            <input type="checkbox" id="broadcast-all-rooms" onchange="toggleSelectAll('broadcast')" checked>
                            <label for="broadcast-all-rooms">Select All Rooms</label>
                        </div>
                        <div id="broadcast-room-chips" class="room-chip-container" style="display: none;">
                            <!-- Room chips will be injected here -->
                        </div>
                    </div>
                    <div class="action-group">
                        <input type="text" id="broadcast-content" data-i18n-placeholder="admin.content_required" style="flex: 1;">
                        <button onclick="adminAction('broadcast')" class="admin-btn action-primary" data-i18n="admin.send">Send</button>
                    </div>
                </div>

                <div class="action-group" style="margin-top: 20px; padding: 0 10px;">
                    <span style="font-weight: bold;" data-i18n="admin.room_creation">Room Creation:</span>
                    <button onclick="adminAction('enable_creation')" class="admin-btn action-success" data-i18n="admin.enable">Enable</button>
                    <button onclick="adminAction('disable_creation')" class="admin-btn action-warning" data-i18n="admin.disable">Disable</button>
                </div>
            </section>

            <!-- Bulk Actions -->
            <section class="panel-card">
                <h2 data-i18n="room.admin.bulk_action">Bulk Room Control</h2>
                <div class="ban-add-section">
                    <div class="room-selector-container">
                        <div class="select-all-row">
                            <input type="checkbox" id="bulk-all-rooms" onchange="toggleSelectAll('bulk')" checked>
                            <label for="bulk-all-rooms">Select All Rooms</label>
                        </div>
                        <div id="bulk-room-chips" class="room-chip-container" style="display: none;">
                            <!-- Room chips will be injected here -->
                        </div>
                    </div>
                    <div class="action-group" style="margin-top: 20px;">
                        <button onclick="adminAction('close_bulk')" class="admin-btn action-danger" data-i18n="admin.close_all">Close All</button>
                        <button onclick="adminAction('lock_bulk')" class="admin-btn action-warning" data-i18n="admin.lock_all">Lock All</button>
                        <button onclick="adminAction('unlock_bulk')" class="admin-btn action-success" data-i18n="admin.unlock_all">Unlock All</button>
                        <div style="display: flex; gap: 10px; align-items: center; border-left: 2px solid var(--border-color); padding-left: 20px; margin-left: 10px;">
                            <input type="number" id="bulk-size" placeholder="Size" style="width: 80px;">
                            <button onclick="adminAction('size_bulk')" class="admin-btn action-warning" style="margin:0;" data-i18n="admin.set_size">Set Size</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ban Management -->
            <section class="panel-card">
                <h2 data-i18n="ban.manage_title">Ban List Management</h2>
                
                <div class="ban-section">
                    <h3 data-i18n="ban.user_id_bans">User ID Bans</h3>
                    <div class="ban-table-container">
                        <table class="ban-table">
                            <thead>
                                <tr>
                                    <th data-i18n="ban.target">Target</th>
                                    <th data-i18n="ban.reason">Reason</th>
                                    <th data-i18n="ban.expires">Expires</th>
                                    <th data-i18n="ban.admin">Admin</th>
                                    <th data-i18n="room.status">Action</th>
                                </tr>
                            </thead>
                            <tbody id="id-ban-list-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="ban-section" style="margin-top: 30px;">
                    <h3 data-i18n="ban.ip_bans">In-game IP Bans</h3>
                    <div class="ban-table-container">
                        <table class="ban-table">
                            <thead>
                                <tr>
                                    <th data-i18n="ban.target">Target</th>
                                    <th data-i18n="ban.reason">Reason</th>
                                    <th data-i18n="ban.expires">Expires</th>
                                    <th data-i18n="ban.admin">Admin</th>
                                    <th data-i18n="room.status">Action</th>
                                </tr>
                            </thead>
                            <tbody id="ip-ban-list-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="ban-add-section">
                    <h4 data-i18n="ban.ban_user">Ban User/IP</h4>
                    <div class="action-group" style="margin-top: 10px;">
                        <select id="ban-type-select" onchange="updateBanTargetUI()">
                            <option value="id" data-i18n="ban.type_user_id">User ID</option>
                            <option value="ip" data-i18n="ban.type_game_ip">In-game IP</option>
                        </select>
                        <div id="ban-target-container" style="display: flex; flex: 1; min-width: 150px;">
                            <select id="ban-user-select" style="width: 100%;">
                                <option value="">-- Select Player --</option>
                            </select>
                            <select id="ban-ip-select" style="width: 100%; display: none;">
                                <option value="">-- Select IP --</option>
                            </select>
                        </div>
                        <input type="number" id="ban-duration-input" data-i18n-placeholder="ban.duration_placeholder" style="width: 120px;">
                        <input type="text" id="ban-reason-input" data-i18n-placeholder="ban.reason_placeholder" style="flex: 1;">
                        <button onclick="executeBan()" class="admin-btn action-danger">OK</button>
                    </div>
                </div>
            </section>

            <!-- Login Blacklist -->
            <section class="panel-card">
                <h2 data-i18n="admin.login_blacklist">Panel Login Blacklist</h2>
                <div class="ban-add-section" style="margin-bottom: 15px;">
                    <div class="action-group">
                        <input type="text" id="blacklist-ip-input" placeholder="Enter IP Address" style="flex: 1;">
                        <input type="number" id="blacklist-duration-input" placeholder="Seconds (optional)" style="width: 150px;">
                        <button onclick="blacklistIpManually()" class="admin-btn action-danger">Add to Blacklist</button>
                    </div>
                </div>
                <div class="ban-table-container">
                    <table class="ban-table">
                        <thead>
                            <tr>
                                <th data-i18n="ban.target">IP Address</th>
                                <th data-i18n="ban.expires">Expires</th>
                                <th data-i18n="room.status">Action</th>
                            </tr>
                        </thead>
                        <tbody id="login-blacklist-body"></tbody>
                    </table>
                </div>
                <div style="margin-top: 10px; color: var(--text-muted); font-size: 0.85rem;">
                    * IPs are automatically added here after too many failed login attempts to the admin panel.
                </div>
            </section>
        </div>

        <footer style="margin-top: 40px; padding: 20px 0; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color);">
            <div data-i18n="admin.footer_version">FunXLink Studio Phira Management Panel v1.0</div>
            <div style="font-family: monospace; font-size: 0.85rem; opacity: 0.8;">
                <span data-i18n="common.server_ip">Server IP:</span> <span id="server-ip">...</span>
            </div>
        </footer>
    </div>

    <script>
        // Auth Check
        async function checkAuth() {
            try {
                const res = await fetch('/check-auth');
                const auth = await res.json();
                if (!auth.isAdmin) {
                    window.location.href = '/admin';
                }
            } catch (e) { window.location.href = '/admin'; }
        }

        // Room Selection Logic
        let activeRooms = [];

        async function fetchActiveRooms() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                activeRooms = data.rooms;
                renderRoomChips('broadcast');
                renderRoomChips('bulk');
            } catch (e) { console.error('Failed to fetch rooms', e); }
        }

        async function fetchOnlinePlayers() {
            try {
                const res = await fetch('/api/all-players');
                const players = await res.json();
                
                const uSelect = document.getElementById('ban-user-select');
                const iSelect = document.getElementById('ban-ip-select');
                
                const currentU = uSelect.value;
                const currentI = iSelect.value;
                
                uSelect.innerHTML = '<option value="">-- Select Player --</option>';
                iSelect.innerHTML = '<option value="">-- Select IP --</option>';
                
                players.forEach(p => {
                    if (p.id === -1) return; // Skip system bot
                    
                    // Populate User ID select
                    const uOption = document.createElement('option');
                    uOption.value = p.id;
                    uOption.textContent = `${p.name} (ID: ${p.id})`;
                    uSelect.appendChild(uOption);
                    
                    // Populate IP select
                    const iOption = document.createElement('option');
                    iOption.value = p.ip;
                    iOption.textContent = `${p.ip} (${p.name})`;
                    iSelect.appendChild(iOption);
                });
                
                uSelect.value = currentU;
                iSelect.value = currentI;
            } catch (e) { console.error('Failed to fetch players', e); }
        }

        function updateBanTargetUI() {
            const type = document.getElementById('ban-type-select').value;
            const userSelect = document.getElementById('ban-user-select');
            const ipSelect = document.getElementById('ban-ip-select');
            
            if (type === 'id') {
                userSelect.style.display = 'block';
                ipSelect.style.display = 'none';
            } else {
                userSelect.style.display = 'none';
                ipSelect.style.display = 'block';
            }
        }

        function renderRoomChips(prefix) {
            const container = document.getElementById(`${prefix}-room-chips`);
            if (!container) return;
            container.innerHTML = '';
            
            if (activeRooms.length === 0) {
                container.innerHTML = `<div style="color: var(--text-muted); padding: 5px; font-size: 0.85rem;">${I18n.t('index.no_rooms')}</div>`;
                return;
            }

            activeRooms.forEach(room => {
                const chip = document.createElement('div');
                chip.className = 'room-chip';
                chip.dataset.id = room.id;
                chip.innerHTML = `<span>#${room.id}</span> <small>(${room.playerCount})</small>`;
                chip.onclick = () => toggleChip(prefix, chip);
                container.appendChild(chip);
            });
        }

        function toggleSelectAll(prefix) {
            const isAll = document.getElementById(`${prefix}-all-rooms`).checked;
            const container = document.getElementById(`${prefix}-room-chips`);
            container.style.display = isAll ? 'none' : 'flex';
        }

        function toggleChip(prefix, chip) {
            chip.classList.toggle('selected');
        }

        function getSelectedRooms(prefix) {
            const isAll = document.getElementById(`${prefix}-all-rooms`).checked;
            if (isAll) return 'all';
            
            const selected = Array.from(document.querySelectorAll(`#${prefix}-room-chips .room-chip.selected`))
                .map(c => c.dataset.id);
            
            if (selected.length === 0) return null;
            return '#' + selected.join(',');
        }

        // Action implementation
        async function adminAction(action) {
            try {
                if (action === 'broadcast') {
                    const target = getSelectedRooms('broadcast');
                    if (!target) return alert(I18n.t('admin.target_required'));
                    const content = document.getElementById('broadcast-content').value;
                    if (!content) return alert(I18n.t('admin.content_required'));
                    const res = await fetch('/api/admin/broadcast', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content, target })
                    });
                    if ((await res.json()).success) alert(I18n.t('room.admin.success'));
                } else if (action === 'enable_creation' || action === 'disable_creation') {
                    const res = await fetch('/api/admin/bulk-action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: action === 'enable_creation' ? 'enable_room_creation' : 'disable_room_creation' })
                    });
                    if ((await res.json()).success) alert(I18n.t('room.admin.success'));
                } else {
                    const target = getSelectedRooms('bulk');
                    if (!target) return alert(I18n.t('admin.target_required'));
                    let apiAction = '';
                    let value = undefined;
                    if (action === 'close_bulk') apiAction = 'close_all';
                    else if (action === 'lock_bulk') apiAction = 'lock_all';
                    else if (action === 'unlock_bulk') apiAction = 'unlock_all';
                    else if (action === 'size_bulk') {
                        apiAction = 'set_max_players';
                        value = parseInt(document.getElementById('bulk-size').value);
                        if (isNaN(value)) return alert(I18n.t('admin.invalid_size'));
                    }
                    if (!confirm(I18n.t('admin.confirm_bulk').replace('{target}', target))) return;
                    const res = await fetch('/api/admin/bulk-action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: apiAction, target, value })
                    });
                    if ((await res.json()).success) {
                        alert(I18n.t('room.admin.success'));
                        if (action === 'close_bulk') {
                            await fetchActiveRooms();
                        }
                    }
                }
            } catch (e) { alert(I18n.t('admin.action_failed')); }
        }

        async function fetchBans() {
            try {
                const res = await fetch('/api/admin/bans');
                const data = await res.json();
                renderBanList('id', data.idBans);
                renderBanList('ip', data.ipBans);
            } catch (e) { console.error('Failed to fetch bans', e); }
        }

        async function fetchLoginBlacklist() {
            try {
                const res = await fetch('/api/admin/login-blacklist');
                const data = await res.json();
                renderLoginBlacklist(data.blacklistedIps);
            } catch (e) { console.error('Failed to fetch login blacklist', e); }
        }

        async function blacklistIpManually() {
            const ipInput = document.getElementById('blacklist-ip-input');
            const durationInput = document.getElementById('blacklist-duration-input');
            const ip = ipInput.value.trim();
            const duration = durationInput.value.trim();
            if (!ip) return alert('Please enter an IP address');
            
            try {
                const res = await fetch('/api/admin/blacklist-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, duration: duration || null })
                });
                if ((await res.json()).success) {
                    alert(I18n.t('room.admin.success'));
                    ipInput.value = '';
                    durationInput.value = '';
                    await fetchLoginBlacklist();
                }
            } catch (e) { alert(I18n.t('admin.action_failed')); }
        }

        function renderLoginBlacklist(ips) {
            const body = document.getElementById('login-blacklist-body');
            if (!body) return;
            body.innerHTML = '';
            if (ips.length === 0) {
                body.innerHTML = `<tr><td colspan="3" style="text-align:center;">No IPs in blacklist</td></tr>`;
                return;
            }
            ips.forEach(item => {
                const row = document.createElement('tr');
                const expiresStr = new Date(item.expiresAt).toLocaleString();
                row.innerHTML = `
                    <td>${item.ip}</td>
                    <td>${expiresStr}</td>
                    <td><button class="admin-btn action-success" style="margin:0; padding:4px 12px;" onclick="unblacklistIp('${item.ip}')">${I18n.t('players.unban')}</button></td>
                `;
                body.appendChild(row);
            });
        }

        async function unblacklistIp(ip) {
            if (!confirm(`Confirm remove ${ip} from login blacklist?`)) return;
            try {
                const res = await fetch('/api/admin/unblacklist-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip })
                });
                if ((await res.json()).success) {
                    alert(I18n.t('room.admin.success'));
                    await fetchLoginBlacklist();
                }
            } catch (e) { alert(I18n.t('admin.action_failed')); }
        }

        function renderBanList(type, bans) {
            const body = document.getElementById(`${type}-ban-list-body`);
            if (!body) return;
            body.innerHTML = '';
            if (bans.length === 0) {
                body.innerHTML = `<tr><td colspan="5" style="text-align:center;">${I18n.t('ban.no_bans')}</td></tr>`;
                return;
            }
            bans.forEach(ban => {
                const row = document.createElement('tr');
                const expiresStr = ban.expiresAt ? new Date(ban.expiresAt).toLocaleString() : I18n.t('ban.permanent');
                row.innerHTML = `
                    <td>${ban.target}</td>
                    <td title="${ban.reason}">${ban.reason}</td>
                    <td>${expiresStr}</td>
                    <td>${ban.adminName || 'Unknown'}</td>
                    <td><button class="admin-btn action-success" style="margin:0; padding:4px 12px;" onclick="unbanTarget('${type}', '${ban.target}')">${I18n.t('players.unban')}</button></td>
                `;
                body.appendChild(row);
            });
        }

        async function executeBan() {
            const type = document.getElementById('ban-type-select').value;
            const uSelect = document.getElementById('ban-user-select');
            const iSelect = document.getElementById('ban-ip-select');
            const target = (type === 'id' ? uSelect.value : iSelect.value).trim();
            
            const duration = document.getElementById('ban-duration-input').value.trim();
            const reason = document.getElementById('ban-reason-input').value.trim();
            
            if (!target) return alert(I18n.t('admin.target_required'));
            
            try {
                const res = await fetch('/api/admin/ban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, target, duration: duration || null, reason: reason || null })
                });
                if ((await res.json()).success) {
                    alert(I18n.t('room.admin.success'));
                    await fetchBans();
                    if (type === 'id') await fetchOnlinePlayers();
                }
            } catch (e) { alert(I18n.t('admin.action_failed')); }
        }

        async function unbanTarget(type, target) {
            if (!confirm(I18n.t('ban.confirm_unban').replace('{target}', target))) return;
            try {
                const res = await fetch('/api/admin/unban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, target })
                });
                if ((await res.json()).success) {
                    alert(I18n.t('room.admin.success'));
                    await fetchBans();
                }
            } catch (e) { alert(I18n.t('admin.action_failed')); }
        }

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        });

        // Init
        document.addEventListener('i18nReady', () => {
            checkAuth();
            fetchBans();
            fetchLoginBlacklist();
            fetchActiveRooms();
            fetchOnlinePlayers();
            
            // Periodically refresh lists
            setInterval(fetchActiveRooms, 5000);
            setInterval(fetchOnlinePlayers, 5000);
            setInterval(fetchLoginBlacklist, 10000);

            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';

            if (window.SERVER_CONFIG && window.SERVER_CONFIG.displayIp) {
                document.getElementById('server-ip').textContent = window.SERVER_CONFIG.displayIp;
            }
        });
    </script>
</body>
</html>
